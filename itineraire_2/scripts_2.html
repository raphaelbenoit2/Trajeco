


<!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <!-- Nous chargeons les fichiers CDN de Leaflet. Le CSS AVANT le JS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        <script type="text/javascript"> 
          
          var points = ["31 rue du rempart Brest"];
          var pointsLat = new Array();
          var pointsLng = new Array();
          var latView;
          var lonView;
          var macarte = null;
          var latLngs = new Array();
          var time_heures;
          var time_minutes;
          var name = new Array();

          
          function appelAjax(point){
            return $.ajax({
              url: "https://nominatim.openstreetmap.org/search", // URL de Nominatim
              type: 'get', // Requête de type GET
              data: "q="+point+"&format=json&addressdetails=1&limit=1&polygon_svg=1",
              async : false
            })
          }


          //if(points.length >= 0) /*&& points[0] != "" && points[points.length-1] != "")*/{
            
            for(var i = 0; i < points.length; i++){
              appelAjax(points[i]).done(function (response) {
                console.log("test");
                if(response != ""){
                  //var ra = response[0]['display_name'];
                  //console.log(ra);
                  pointsLat[i] = response[0]['lat'];
                  pointsLng[i] = response[0]['lon'];
                  
                  //name[i] = response[0]['display_name'];
                  
                  /*
                  for(var i = 0; i < name.length; i++){
                    console.log(name[i])
                  } 
                   */
                }
                
                if(pointsLat[i] == undefined || pointsLng[i] == undefined){
                  alert("'" + points[i] + "'" + " non trouvé, veuillez vérifier l’orthographe");
                }
              }).fail(function (error) {
                alert(error);
              });
            }

            latView = (parseFloat(pointsLat[0]) + parseFloat(pointsLat[pointsLat.length-1])) / 2;
            lonView = (parseFloat(pointsLng[0]) + parseFloat(pointsLng[pointsLng.length-1])) / 2;
            for(var i = 0; i < pointsLat.length; i++){
              latLngs[i] = L.latLng([pointsLat[i],pointsLng[i]])
            }
          
          //}
          /*else if(points.length > 0 && points[0] != ""){
            appelAjax(points[i]).done(function (response) {
              if(response != ""){
                pointsLat[0] = response[0]['lat'];
                pointsLng[0] = response[0]['lon'];     
              }
            }).fail(function (error) {
              alert(error);
            });
            latView = pointsLat[0];
            lonView = pointsLng[0];
          
          }
          
          else{
            alert("Vous ètes perdus dans le triangle des bermudes");
            appelAjax("Triangle des bermudes").done(function (response) {
              if(response != ""){
                pointsLat[0] = response[0]['lat'];
                pointsLng[0] = response[0]['lon'];     
              }                
            }).fail(function (error) {
              alert(error);
            });
            latView = pointsLat[0];
            lonView = pointsLng[0];
          }
          
*/

          function initControl(wp){
            var routingControl = L.Routing.control({
              waypoints: wp,
              language: 'fr',
              show : true,
              routeWhileDragging: true,
              geocoder: L.Control.Geocoder.nominatim(),
              autoRoute: true
            });

            routingControl.addTo(macarte);
            routingControl.route();
            routingControl.addEventListener('routesfound', function(routingResultEvent){
              $('body').removeClass('waiting');
              var route = routingResultEvent.routes[0].summary;
              //var r = routingResultEvent.routes[1].name;
              console.log(wp.name);
              var distance = route.totalDistance/1000;
              time_heures = route.totalTime/3600
              time_minutes = (time_heures%1)*60;
              
              time_heures = time_heures - time_heures%1;
              if(time_minutes%1 < 0.5){
                time_minutes = time_minutes - time_minutes%1;
              }else{
                time_minutes = (time_minutes - time_minutes%1) + 1;
              }
              
              alert("distance : " + distance.toFixed(1) + " km\n" + "durée : " + time_heures + " h " + time_minutes + " min");
              var start = $("div.leaflet-routing-geocoder").find("Input")[1].value;
              console.log(start);
            })
            routingControl.addEventListener('routingerror', function(routingErrorEvent){
              $('body').addClass('waiting');
            })
          }
          
          window.onload = function(){
            // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView([latView, lonView], 8);
            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
              // Il est toujours bien de laisser le lien vers la source des données
              attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
              minZoom: 1,
              maxZoom: 20
            }).addTo(macarte);
            initControl(latLngs);
          };

          // $("#search").click(function(){
          //   points = ["Rennes"];
          //   appelAjax("Rennes");
          // });
           
          </script>
          <style type="text/css">
            #map{ /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            height:600px;
          }
          body.waiting * {
            cursor: progress;
          }
        </style>
          <title>Carte</title>
        </head>
      <body>
         <h1>Hello world !</h1>
         <form>
            <div>
              <label for="name">Nom :</label>
              <input type="text" id="name" name="user_name">
            </div>
            <div>
              <label for="mail">e-mail :</label>
              <input type="email" id="mail" name="user_mail">
            </div>
            <div>
                <button id="search">Recherche</button>
            </div>
              </form>
        <div id="map">
        <!-- Ici s'affichera la carte -->
        </div>
      </body>
    </html>

